{% extends 'base.html' %}

{% block content %}


  <h1>Lista de Materiales</h1>
<br>
<div class="input-group w-25 mb-3">
  <input class="form-control" type="text" id="buscador" placeholder="Buscar por nombre">
  <input type="hidden" id="materialUrl" value="{% url 'ver_material' 999999 %}">
</div>
<div id="resultadosBusqueda"></div>
  <!-- Sección para mostrar mensajes -->
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
  {% endfor %}

<!-- Dropdown para seleccionar el campo de filtro -->
<select id="filtroCampo">
    <option value="marca">Marca</option>
    <option value="proveedor">Proveedor</option>
    <option value="unidadesStock">Unidades en stock</option>
</select>

<!-- Dropdown para seleccionar el valor específico del filtro -->
<select id="filtroValor">
    <!-- Este se llenará dinámicamente usando JS -->
</select>

<button id="aplicarFiltro" class="btn btn-primary">Filtrar</button>
  <hr>

  {% if materiales %}
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Marca</th>
          <th>Proveedor</th>
          <th>Medida</th>
          <th>Mínimo</th>
          <th>Unidades en Stock</th>
          <th>Imagen</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for material in page_obj %}
          <tr>
            <td>{{ material.id }}</td>
            <td>{{ material.nombre }}</td>
            <td>{{ material.marca }}</td>
            <td>{{ material.id_proveedor }}</td>
            <td>{{ material.medida }}</td>
            <td>{{ material.minimo }}</td>
            <td>{{ material.unidades_stock }}</td>
            {% if material.fotografia %}
              <td><a href="/{{ material.fotografia }}" target="_blank"><img src="/{{ material.fotografia }}"></a></td>
            {% else %}
              <td>--</td>
            {% endif %}
            <td>
              <a href="{% url 'editar_material' material.id %}" class="btn btn-primary">Editar</a>
              <!-- Actualización del enlace de eliminación -->
              <a href="{% url 'ver_materiales' %}?eliminar_material_id={{ material.id }}" class="btn btn-primary">Eliminar</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
<nav>
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page=1">Primera</a></li>
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
    {% else %}
      <li class="page-item disabled"><a class="page-link">Primera</a></li>
      <li class="page-item disabled"><a class="page-link">Anterior</a></li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><a class="page-link">{{ num }}</a></li>
      {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última</a></li>
    {% else %}
      <li class="page-item disabled"><a class="page-link">Siguiente</a></li>
      <li class="page-item disabled"><a class="page-link">Última</a></li>
    {% endif %}
  </ul>
</nav>

  {% else %}
    <p>No se encontraron materiales.</p>
  {% endif %}
  <a href="{% url 'registrar_material' %}" class="btn btn-primary">Registrar Material</a>
  <a href="{% url 'inicio' %}" class="btn btn-primary">Inicio</a>

{% endblock %}
{% block extra_js %}
<script>
  //buscador
    document.getElementById('buscador').addEventListener('input', function() {
        let query = this.value;
        let resultadosDiv = document.getElementById('resultadosBusqueda');
        let baseUrl = document.getElementById('materialUrl').value;

        if (query.length >= 3) {
            fetch(`/buscar_materiales/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                resultadosDiv.innerHTML = '';  // Limpiar resultados anteriores
                data.forEach(material => {
                    let div = document.createElement('div');
                    let materialUrl = baseUrl.replace('999999', material.id);
                    div.innerHTML = `<a class="container" href="${materialUrl}">${material.nombre}</a>`;
                    resultadosDiv.appendChild(div);
                });
            });
        } else {
            resultadosDiv.innerHTML = '';  // Limpiar resultados si la consulta es demasiado corta
        }
    });
    // primer dropdown de filtro
    document.getElementById('filtroCampo').addEventListener('change', function() {
      let campoSeleccionado = this.value;
      let dropdownValor = document.getElementById('filtroValor');

      // Limpiar opciones previas
      dropdownValor.innerHTML = '';

      let url = '';  // URL de donde obtener los datos

      switch (campoSeleccionado) {
          case 'marca':
              url = '/obtener_materiales_marca/';
              break;
          case 'proveedor':
              url = '/obtener_materiales_proveedor/';
              break;
          case 'unidadesStock':
              url = '/obtener_materiales_stock/';
              break;
      }

      // Si hay una URL válida, hacer la solicitud AJAX
      if (url) {
          fetch(url)
          .then(response => response.json())
          .then(data => {
              data.forEach(item => {
                  let option = document.createElement('option');
                  option.value = item;
                  option.text = item;
                  dropdownValor.appendChild(option);
              });
          })
          .catch(error => {
              console.error('Error al obtener datos:', error);
          });
      }
    });

// codigo para mandar a la vista el valor del segundo dropdown

function filtrarMateriales() {
    let campoSeleccionado = document.getElementById('filtroCampo').value;
    let valorSeleccionado = document.getElementById('filtroValor').value;
    let url = '';

    switch (campoSeleccionado) {
        case 'marca':
            url = `/ver_materiales_marca/${valorSeleccionado}/`;
            break;
        case 'proveedor':
            url = `/ver_materiales_proveedor/${valorSeleccionado}/`;
            break;
        case 'unidadesStock':
            url = `/ver_materiales_stock/${valorSeleccionado}/`;
            break;
    }

    if (url) {
        window.location.href = url;
    }
    }

    document.getElementById('filtroValor').addEventListener('change', filtrarMateriales);
    document.getElementById('aplicarFiltro').addEventListener('click', filtrarMateriales);

</script>
{% endblock %}