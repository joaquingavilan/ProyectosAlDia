{% extends 'base_gerente.html' %}

{% block title %}Resumen de obra{% endblock %}

{% block content %}
<div class="page-title">
    <div class="title_left">
        <h3>Resumen de la obra {{nombre_obra}}</h3>
        <h3>Cliente: {{nombre_cliente}}</h3>
        <h3>Ingeniero a cargo de la obra : {{nombre_ing_obra}}</h3>
        <h3>Presupuesto elaborado por {{nombre_ing_pres}}</h3>
    </div>
</div>

<div class="clearfix"></div>

<div class="row">
        {% block grafico_5 %}
    <div class="col-md-8 col-sm-8">
        <div class="x_panel">
            <div class="x_title">
                <h2>Cronograma de la Obra</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="grafico-cronograma"></div>
            </div>
        </div>
    </div>
    {% endblock %}






{% block grafico_3 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Montos de Certificados por Fecha</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div id="grafico-certificados"></div>
        </div>
    </div>
</div>
{% endblock %}

</div>

<div class="row">
    {% block grafico_2 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Gr치fico de Materiales por Obra</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <select id="material-select" class="form-control">
                <option value="">Selecciona un Material</option>
                {% for material in hechos_materiales %}
                <option value="{{ material.material_nombre }}">{{ material.material_nombre }}</option>
                {% endfor %}
            </select>
            <div id="unidad-medida" style="margin-top: 10px;"></div>
            <div id="grafico-materiales">
                <p id="texto-inicial">Seleccione un material para ver el consumo</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
    {% block grafico_4 %}
    <div class="col-md-4 col-sm-4">
        <div class="x_panel">
            <div class="x_title">
                <h2>Devoluciones de materiales</h2>
                <div class="clearfix"></div>
            </div>
    <div class="x_content">
                {% if devoluciones %}
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Id de la devolucion</th>
                            <th>Id del pedido </th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for devolucion in devoluciones %}
                        <tr>
                            <td>{{ devolucion.id }}</td>
                            <td>{{ devolucion.pedido.id }}</td>
                            <td>{{ devolucion.get_estado_display }}
                            </td>
                            <td><a href="{% url 'ver_devolucion' devolucion.id %}" class="btn btn-info btn-sm">Ver</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <h6>No hay devoluciones registradas</h6>
                {% endif %}
            </div>
        </div>
    </div>
    {% endblock %}
{% block grafico_1 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Pedidos de materiales</h2>
            <div class="clearfix"></div>
        </div>
<div class="x_content">
            {% if pedidos %}
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Id del pedido</th>
                        <th>Fecha de solicitud</th>
                        <th>Fecha de entrega</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr>
                        <td>{{ pedido.id }}</td>
                        <td>{{ pedido.fecha_solicitud }}</td>
                        <td>{% if pedido.fecha_entrega %}
                            {{ pedido.fecha_entrega }}
                            {% else %}
                            No entregado
                            {% endif %}
                        </td>
                        <td><a href="{% url 'ver_pedido_gerente' pedido.id %}" class="btn btn-info btn-sm">Ver</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <h6>No hay pedidos realizados</h6>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}



</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var graphJSON = "{{ graph_json|escapejs }}";
    var certificadosJSON = "{{ certificados_json|escapejs }}";
    var cronogramaJSON = "{{ graph_json_cronograma|escapejs }}";
    var cronogramaData = JSON.parse(cronogramaJSON);

    // Renderizar gr치fico de cronograma
    if (cronogramaData.data.length > 0) {
        Plotly.react('grafico-cronograma', cronogramaData.data, cronogramaData.layout);
    } else {
        document.getElementById('grafico-cronograma').innerHTML = '<p>No hay datos disponibles para mostrar.</p>';
    }

    var data = JSON.parse(graphJSON);
    var certificadosData = JSON.parse(certificadosJSON);


    var initialData = data.data;
    var layout = data.layout;

    var unidadesMedida = {{ unidades_medida|safe }};
    // Verificar los datos en la consola
    console.log('cronogramaData:', cronogramaData);
    // Renderizar gr치fico de materiales
    document.getElementById('material-select').addEventListener('change', function (e) {
        var selectedMaterial = e.target.value;
        var filteredData;
        var graficoContainer = document.getElementById('grafico-materiales');
        var textoInicial = document.getElementById('texto-inicial');
        var unidadMedida = document.getElementById('unidad-medida');

        if (selectedMaterial) {
            filteredData = initialData.filter(function (trace) {
                return trace.name === selectedMaterial;
            });
            textoInicial.style.display = 'none';
            unidadMedida.innerHTML = '<strong>Unidad de medida: </strong>' + unidadesMedida[selectedMaterial];
            Plotly.react(graficoContainer, filteredData, layout);
        } else {
            Plotly.purge(graficoContainer);
            textoInicial.style.display = 'block';
            unidadMedida.innerHTML = '';
        }
    });

    // Renderizar gr치fico de certificados
    if (certificadosData.data.length > 0) {
        Plotly.react('grafico-certificados', certificadosData.data, certificadosData.layout).then(function(gd) {
            gd.on('plotly_click', function(data){
                var point = data.points[0];
                var certificadoId = point.customdata;
                window.location.href = '/ver_certificado_gerente/' + certificadoId;
            });
        });
    } else {
        document.getElementById('grafico-certificados').innerHTML = '<p>No hay datos disponibles para mostrar.</p>';
    }


});
</script>

{% endblock %}