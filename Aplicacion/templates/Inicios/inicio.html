{% extends 'base_gerente.html' %}

{% block title %}Panel de Visualizaciones{% endblock %}

{% block content %}

<div class="clearfix"></div>

<div class="row">





{% block grafico_1 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Estado de Ingenieros</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content" style="overflow-x: auto;">
            <div id="grafico-estado-ingenieros" style="min-width: 100%;"></div>
        </div>
    </div>
</div>
{% endblock %}


{% block grafico_2 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Presupuestos Pendientes de Aprobacion</h2>
            <div class="clearfix"></div>
        </div>
        <div id="contenido-presupuestos-pendientes" class="x_content" style="height: 450px; overflow-y: auto; width: 100%;">
            <!-- Establecer una altura específica para el div del gráfico para permitir el scrolling cuando sea necesario -->
            <div id="plotly-graph-div-presupuestos" style="height: 450px;"> <!-- Ajusta esta altura según el número esperado de clientes -->
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block grafico_3 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Certificados Pendientes</h2>
            <div class="clearfix"></div>
        </div>
        <div id="contenido-certificados-pendientes" class="x_content" style="min-height: 450px; height: 450px; width: 100%;">
            <div id="plotly-graph-div-certificados"></div>
        </div>
    </div>
</div>
{% endblock %}





</div>

<div class="row">

{% block grafico_4 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Obras Activas</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div id="contenido-obras-activas">
                <div class="row">
                    <div class="col-md-5">
                        <select id="filtro-cliente" class="form-control">
                            <option value="">Todos los Clientes</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-5">
                        <select id="filtro-ingeniero" class="form-control">
                            <option value="">Todos los Ingenieros</option>
                            {% for ingeniero in ingenieros_encargados %}
                            <option value="{{ ingeniero.id }}">{{ ingeniero.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="borrar-filtros" class="btn btn-secondary mb-3">Limpiar</button>
                    </div>
                </div>

                <div id="tabla-obras-activas">
                    <!-- Aquí se cargará la tabla de obras activas -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block grafico_5 %}
<div class="col-md-4 col-sm-4">
    <div class="x_panel">
        <div class="x_title">
            <h2>Presupuestos en elaboracion</h2>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div id="contenido-presupuestos-elaboracion">
                <div class="row">
                    <div class="col-md-5">
                        <select id="filtro-cliente_pres" class="form-control">
                            <option value="">Todos los Clientes</option>
                            {% for cliente in clientes_pres %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-5">
                        <select id="filtro-ingeniero_pres" class="form-control">
                            <option value="">Todos los Ingenieros</option>
                            {% for ingeniero in ingenieros_pres %}
                            <option value="{{ ingeniero.id }}">{{ ingeniero.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="borrar-filtros_pres" class="btn btn-secondary mb-3">Limpiar</button>
                    </div>
                </div>

                <div id="tabla-presupuestos-elaboracion">
                    <!-- Aquí se cargará la tabla de obras activas -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


    {% block grafico_6 %}
    <div class="col-md-4 col-sm-4">
        <div class="x_panel">
            <div class="x_title">
                <h2>Gráfico 6</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <!-- Aquí irá la imagen de la visualización -->
            </div>
        </div>
    </div>
    {% endblock %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    function cargarObrasActivas() {
        var cliente = $('#filtro-cliente').val();
        var ingeniero = $('#filtro-ingeniero').val();
        var page = 1;

        $.ajax({
            url: "{% url 'get_obras_activas' %}",
            data: {
                cliente: cliente,
                ingeniero: ingeniero,
                page: page
            },
            success: function(data) {
                if (data.obras.length === 0) {
                    $('#contenido-obras-activas').html('<p>No hay Obras activas</p>');
                } else {
                    var obrasHtml = '<div class="row">' +
                                    '<div class="col-md-5">' +
                                    '<select id="filtro-cliente" class="form-control">' +
                                    '<option value="">Todos los Clientes</option>' +
                                    '{% for cliente in clientes %}' +
                                    '<option value="{{ cliente.id }}">{{ cliente.nombre }}</option>' +
                                    '{% endfor %}' +
                                    '</select>' +
                                    '</div>' +
                                    '<div class="col-md-5">' +
                                    '<select id="filtro-ingeniero" class="form-control">' +
                                    '<option value="">Todos los Ingenieros</option>' +
                                    '{% for ingeniero in ingenieros_encargados %}' +
                                    '<option value="{{ ingeniero.id }}">{{ ingeniero.get_full_name }}</option>' +
                                    '{% endfor %}' +
                                    '</select>' +
                                    '</div>' +
                                    '<div class="col-md-2 d-flex align-items-end">' +
                                    '<button id="borrar-filtros" class="btn btn-secondary mb-3">Limpiar</button>' +
                                    '</div>' +
                                    '</div>' +
                                    '<table class="table table-striped">';
                    obrasHtml += '<thead><tr><th>Nombre</th><th>Cliente</th><th>Ingeniero</th><th>Acciones</th></tr></thead><tbody>';
                    $.each(data.obras, function(index, obra) {
                        obrasHtml += '<tr>';
                        obrasHtml += '<td>' + obra.proyecto.nombre + '</td>';
                        obrasHtml += '<td>' + obra.proyecto.cliente.nombre + '</td>';
                        obrasHtml += '<td>' + obra.encargado.get_full_name + '</td>';
                        obrasHtml += '<td><a href="' + "{% url 'ver_resumen_obra' '0' %}".replace('0', obra.id) + '" class="btn btn-info btn-sm">Resumen</a></td>';
                        obrasHtml += '</tr>';
                    });
                    obrasHtml += '</tbody></table>';
                    $('#contenido-obras-activas').html(obrasHtml);

                    // Reattach event handlers to the new elements
                    $('#filtro-cliente').change(cargarObrasActivas);
                    $('#filtro-ingeniero').change(cargarObrasActivas);
                    $('#borrar-filtros').click(function() {
                        $('#filtro-cliente').val('');
                        $('#filtro-ingeniero').val('');
                        cargarObrasActivas();
                    });
                }
            }
        });
    }

    $('#filtro-cliente').change(cargarObrasActivas);
    $('#filtro-ingeniero').change(cargarObrasActivas);
    $('#borrar-filtros').click(function() {
        $('#filtro-cliente').val('');
        $('#filtro-ingeniero').val('');
        cargarObrasActivas();
    });

    cargarObrasActivas(); // Cargar obras activas al cargar la página


function cargarPresupuestosElaboracion() {
        var cliente_p = $('#filtro-cliente_pres').val();
        var ingeniero_p = $('#filtro-ingeniero_pres').val();
        var page = 1;
        console.log(cliente_p)
        console.log(ingeniero_p)

        $.ajax({
            url: "{% url 'get_presupuestos_elaboracion' %}",
            data: {
                cliente: cliente_p,
                ingeniero: ingeniero_p,
                page: page
            },
            success: function(data) {
                if (data.presupuestos.length === 0) {
                    $('#contenido-presupuestos-elaboracion').html('<p>No hay Presupuestos en elaboracion</p>');
                } else {
                    var presupuestosHtml = '<div class="row">' +
                                    '<div class="col-md-5">' +
                                    '<select id="filtro-cliente_pres" class="form-control">' +
                                    '<option value="">Todos los Clientes</option>' +
                                    '{% for cliente in clientes_pres %}' +
                                    '<option value="{{ cliente.id }}">{{ cliente.nombre }}</option>' +
                                    '{% endfor %}' +
                                    '</select>' +
                                    '</div>' +
                                    '<div class="col-md-5">' +
                                    '<select id="filtro-ingeniero_pres" class="form-control">' +
                                    '<option value="">Todos los Ingenieros</option>' +
                                    '{% for ingeniero in ingenieros_pres %}' +
                                    '<option value="{{ ingeniero.id }}">{{ ingeniero.get_full_name }}</option>' +
                                    '{% endfor %}' +
                                    '</select>' +
                                    '</div>' +
                                    '<div class="col-md-2 d-flex align-items-end">' +
                                    '<button id="borrar-filtros_pres" class="btn btn-secondary mb-3">Limpiar</button>' +
                                    '</div>' +
                                    '</div>' +
                                    '<table class="table table-striped">';
                    presupuestosHtml += '<thead><tr><th>Nombre</th><th>Cliente</th><th>Ingeniero</th><th>Fecha de solicitud</th></tr></thead><tbody>';
                    $.each(data.presupuestos, function(index, presupuesto) {
                        presupuestosHtml += '<tr>';
                        presupuestosHtml += '<td>' + presupuesto.proyecto.nombre + '</td>';
                        presupuestosHtml += '<td>' + presupuesto.proyecto.cliente.nombre + '</td>';
                        presupuestosHtml += '<td>' + presupuesto.encargado.get_full_name + '</td>';
                        presupuestosHtml += '<td>'+ presupuesto.fecha_asignacion + '</td>';
                        presupuestosHtml += '</tr>';
                    });
                    presupuestosHtml += '</tbody></table>';
                    $('#contenido-presupuestos-elaboracion').html(presupuestosHtml);

                    // Reattach event handlers to the new elements
                    $('#filtro-cliente_pres').change(cargarPresupuestosElaboracion);
                    $('#filtro-ingeniero_pres').change(cargarPresupuestosElaboracion);
                    $('#borrar-filtros_pres').click(function() {
                        $('#filtro-cliente_pres').val('');
                        $('#filtro-ingeniero_pres').val('');
                        cargarPresupuestosElaboracion();
                    });
                }
            }
        });
    }

    $('#filtro-cliente_pres').change(cargarPresupuestosElaboracion);
    $('#filtro-ingeniero_pres').change(cargarPresupuestosElaboracion);
    $('#borrar-filtros_pres').click(function() {
        $('#filtro-cliente_pres').val('');
        $('#filtro-ingeniero_pres').val('');
        cargarPresupuestosElaboracion();
    });

    cargarPresupuestosElaboracion(); // Cargar presupestos en elaboracion al cargar la página



var graphDataCertificadosPendientes = JSON.parse('{{ graph_data_certificados_pendientes|escapejs }}');
var dataCertificados = [{
    values: [],
    labels: [],
    customdata: [],  // Aquí almacenamos los IDs de los certificados
    type: 'pie',
    textinfo: 'value',
    textposition: 'auto',
    hoverinfo: 'label',
    hole: 0.4,  // Esto crea un gráfico de dona, si prefieres un pie completo, puedes omitir esta línea.
    marker: {
        colors: [], // Aquí puedes personalizar los colores de cada "slice" si lo deseas.
    }
}];

graphDataCertificadosPendientes.proyectos.forEach(function(proyecto) {
    var certificados = graphDataCertificadosPendientes.certificados_proyecto[proyecto];
    var totalMonto = certificados.reduce((total, certificado) => total + certificado.monto, 0);

    var certificadoRepresentanteId = certificados[0].id;

    dataCertificados[0].values.push(totalMonto);
    dataCertificados[0].labels.push(proyecto);
    dataCertificados[0].customdata.push(certificadoRepresentanteId);  // Guardamos el ID del certificado representante
});

// Aquí puedes especificar colores específicos si lo deseas, o dejar que Plotly maneje los colores automáticamente.
dataCertificados[0].marker.colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];

var layoutCertificados = {
    height: 460,
    width: 550
};

Plotly.newPlot('plotly-graph-div-certificados', dataCertificados, layoutCertificados).then(function(gd) {
    gd.on('plotly_click', function(data){
        var point = data.points[0];
        var certificadoId = point.customdata;

        console.log('Certificado seleccionado:', certificadoId);

        // Redireccionamos a la URL del certificado gerente con el ID del certificado
        window.location.href = '/ver_certificado_gerente/' + certificadoId;
    });
});







    // Datos para el gráfico de Estado de Ingenieros
    var graphDataEstadoIngenieros = JSON.parse('{{ graph_data_estado_ingenieros|escapejs }}');
    var maxSum = Math.max(...graphDataEstadoIngenieros.obras_ejecucion.map((value, index) => value + graphDataEstadoIngenieros.presupuestos_elaboracion[index]));
    var numIngenieros = graphDataEstadoIngenieros.nombres.length;
    var minWidthPerIngeniero = 90; // Ajusta esto según el ancho deseado por columna
    document.getElementById('grafico-estado-ingenieros').style.width = `${numIngenieros * minWidthPerIngeniero}px`;

    var trace2 = {
        x: graphDataEstadoIngenieros.nombres,
        y: graphDataEstadoIngenieros.obras_ejecucion,
        name: 'Obras en ejecución',
        type: 'bar'
    };

    var trace3 = {
        x: graphDataEstadoIngenieros.nombres,
        y: graphDataEstadoIngenieros.presupuestos_elaboracion,
        name: 'Presupuestos en elaboración',
        type: 'bar'
    };

    var dataIngenieros = [trace2, trace3];

    var layoutIngenieros = {
        barmode: 'stack',
        xaxis: { title: 'Ingenieros' },
        yaxis: {
            title: 'Cantidad',
            dtick: 1,
            range: [0, maxSum * 1.1]  // Asegura que el eje Y comience en 0 y tenga un poco de espacio por encima del valor máximo
        },
        autosize: true,
        margin: {
            l: 50,
            r: 50,
            t: 50,
            b: 50,
            pad: 4
        },
        legend: {
            orientation: 'h',
            y: 1.1,
            x: 0.5,
            xanchor: 'center',
            yanchor: 'bottom'
        },
        responsive: true
    };

    Plotly.newPlot('grafico-estado-ingenieros', dataIngenieros, layoutIngenieros);

var graphDataPresupuestosPendientes = JSON.parse('{{ graph_data_presupuestos_pendientes|escapejs }}');
console.log("Clientes ordenados recibidos:", graphDataPresupuestosPendientes.clientes);

var dataPresupuestos = [];
var clientCount = graphDataPresupuestosPendientes.clientes.length;
var minHeightPerClient = 50; // altura mínima por cliente en píxeles, ajusta según necesidad
var totalGraphHeight = clientCount * minHeightPerClient;

graphDataPresupuestosPendientes.clientes.forEach(function(cliente) {
    var presupuestos = graphDataPresupuestosPendientes.presupuestos_cliente[cliente];
    var yBase = 0;

    presupuestos.forEach(function(presupuesto) {
        dataPresupuestos.push({
            y: [cliente],
            x: [1],
            base: yBase,
            text: [presupuesto.proyecto_nombre],
            textposition: 'auto',
            hovertemplate: 'ID Presupuesto: %{customdata}<extra></extra>',
            customdata: [presupuesto.id],
            orientation: 'h',
            type: 'bar',
            width: 0.5, // ancho de la barra, ajusta según necesidad
            marker: {
                color: '#1f77b4',
                line: {
                    width: 1,
                    color: 'white'
                }
            }
        });

        yBase += 1;
    });
});

var layoutPresupuestos = {
    barmode: 'stack',
    yaxis: {
        title: 'Clientes',
        automargin: true,
        tickfont: { size: 16 },
        type: 'category', // Asegura que Plotly trate las etiquetas como categorías discretas
        categoryorder: 'array', // Forza el orden de categorías como en el arreglo
        categoryarray: graphDataPresupuestosPendientes.clientes
    },
    xaxis: {
        title: 'Número de Presupuestos',
        dtick: 1
    },
    autosize: true,
    height: totalGraphHeight,
    width: 550,
    margin: { l: 100, r: 50, t: 50, b: 50, pad: 4 },
    plot_bgcolor: 'white',
    paper_bgcolor: 'white',
    responsive: true,
    hovermode: 'closest',
    showlegend: false
};

Plotly.newPlot('plotly-graph-div-presupuestos', dataPresupuestos, layoutPresupuestos).then(function(gd) {
    gd.on('plotly_click', function(data){
        var point = data.points[0];
        var presupuestoId = point.customdata;
        window.location.href = '/ver_archivo_presupuesto/' + presupuestoId;
    });
});





});
</script>
{% endblock %}

