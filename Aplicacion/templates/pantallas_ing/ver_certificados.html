{% extends 'base_ing.html' %} <!-- Asumiendo que ya tienes un template base para el ingeniero -->
{% load custom_filters %}

{% block content %}
<div class="x_panel">
    <h2 class="x_title">{{ title }}</h2> <!-- Ajusta el tamaño de la fuente según sea necesario -->
    <div class="clearfix"></div>

        <div class="x_content">
        <div class="d-flex justify-content-end mb-3">
            <a href="{% url 'elaborar_certificado' %}" class="btn btn-primary">Elaborar nuevo certificado</a>
        </div>
        {% if certificados %}
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Proyecto</th>
                        <th>Fecha de creación</th>
                        <th>Estado</th>
                        <th>Fecha de envio</th>
                        <th>Fecha de pago</th>
                        <th>Monto total</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for certificado in certificados %}
                    <tr>
                        <td>{{ certificado.presupuesto.proyecto.nombre }}</td>
                        <td>
                            {{ certificado.fecha_creacion }}</td>
                        <td>
                            {{ certificado.get_estado_display }}</td>
                        <td>
                            {% if certificado.fecha_envio %}
                            {{ certificado.fecha_envio }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{% if certificado.fecha_pago %}
                            {{ certificado.fecha_pago }}
                            {% else %}
                            -
                            {% endif %}</td>
                        <td>
                            {{ certificado.monto_total| intcomma }}
                        </td>
                        <td>
                            <a href="{% url 'ver_archivo_certificado' certificado.id %}" class="btn btn-primary btn-sm">Ver Certificado</a>
                            {% if certificado.estado == 'P' %}
                            <button class="btn btn-primary btn-sm marcar-enviado-btn" data-id="{{ certificado.id }}">Marcar como enviado</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-light" role="alert">
                No se encontraron certificados.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const enviadoBtns = document.querySelectorAll('.marcar-enviado-btn');
    enviadoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const certificadoId = this.getAttribute('data-id');
            fetch(`/marcar-enviado/${certificadoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'), // Asegúrate de obtener el CSRF token
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ certificadoId }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                location.reload();
            })
            .catch(error => console.error('Error:', error));
        });
    });
    const pagoBtns = document.querySelectorAll('.registrar-pago-btn');
    pagoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const certificadoId = this.getAttribute('data-id');
    console.log(certificadoId)

            // Actualizar el contenido del modal
            document.getElementById('modalCertificado').textContent = "Certificado ID: " + certificadoId;

            const inputComprobante = document.getElementById('comprobantePago');
            inputComprobante.setAttribute('data-certificado-id', certificadoId);

            // Configurar el atributo data-certificado-id del botón "Registrar Pago"
            const botonRegistrar = document.querySelector('#modalRegistroPago button[data-certificado-id]');
            botonRegistrar.setAttribute('data-certificado-id', certificadoId);

            // Mostrar el modal
            $('#modalRegistroPago').modal('show');
        });
    });
});
function registrarPago(buttonElem) {
    event.preventDefault();
    const idCertificado = buttonElem.getAttribute('data-certificado-id');
    console.log(idCertificado)
    const inputFile = document.getElementById('comprobantePago');

    if (!inputFile.files.length) {
        alert('Cargue el comprobante para registrar el pago');
        return;
    }

    const formData = new FormData();
    formData.append('comprobantePago', inputFile.files[0]);
    formData.append('pago', true);

    fetch(`/registrar_pago_certificado/${idCertificado}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#modalRegistroPago').modal('hide');
            location.reload();
        } else {
            alert('Hubo un error al registrar el pago');
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}



